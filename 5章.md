### 与http协作的web服务器

#### 单台主机实现多个域名

#### 通信数据转发程序 ：代理、网关、隧 道

##### 代理
代理是一种有转发功能的应用程序，它扮演了位于服务器和客户 端“中间人”的角色，接收由客户端发送的请求并转发给服务器，同时 也接收服务器返回的响应并转发给客户端。

###### 缓存代理
代理转发响应时，缓存代理（Caching Proxy）会预先将资源的副本 （缓存）保存在代理服务器上。
当代理再次接收到对相同资源的请求时，就可以不从源服务器那里获 取资源，而是将之前缓存的资源作为响应返回。

###### 透明代理
转发请求或响应时，不对报文做任何加工的代理类型被称为透明代理 （Transparent Proxy）。反之，对报文内容进行加工的代理被称为非 透明代理。

#####  网关
网关是转发其他服务器通信数据的服务器，接收从客户端发送来的请 求时，它就像自己拥有资源的源服务器一样对请求进行处理。有时客 户端可能都不会察觉，自己的通信目标是一个网关。

##### 隧道

隧道是在相隔甚远的客户端和服务器两者之间进行中转，并保持双方 通信连接的应用程序。

#### 缓存

缓存是指代理服务器或客户端本地磁盘内保存的资源副本。利用缓存 可减少对源服务器的访问，因此也就节省了通信流量和通信时间。

##### 缓存的有效期限

##### 客户端的缓存

缓存不仅可以存在于缓存服务器内，还可以存在客户端浏览器中。以 Internet Explorer 程序为例，把客户端缓存称为临时网络文件 （Temporary Internet File）。
浏览器缓存如果有效，就不必再向服务器请求相同的资源了，可以直 接从本地磁盘内读取。

### HTTP首部

#### http报文首部

##### HTTP请求报文

![](C:\Users\Administrator\Desktop\图解http笔记\http\捕获21.PNG)

##### HTTP响应报文

![](C:\Users\Administrator\Desktop\图解http笔记\http\捕获22.PNG)

#### 首部字段

#### HTTP首部字段传递重要信息

使用首部字段是为了给浏览器和服务器提供报文主体大小、所使用的 语言、认证信息等内容。

##### http首部字段

###### 通用首部字段

请求报文和响应报文两方都会使用的首部。

![](C:\Users\Administrator\Desktop\图解http笔记\http\捕获23.PNG)

###### 请求首部字段

![](C:\Users\Administrator\Desktop\图解http笔记\http\捕获24.PNG)

从客户端向服务器端发送请求报文时使用的首部。补充了请求的附加 内容、客户端信息、响应内容相关优先级等信息。

###### 响应首部字段

![](C:\Users\Administrator\Desktop\图解http笔记\http\捕获25.PNG)

从服务器端向客户端返回响应报文时使用的首部。补充了响应的附加 内容，也会要求客户端附加额外的内容信息。

###### 实体首部字段

![](C:\Users\Administrator\Desktop\图解http笔记\http\捕获26.PNG)

针对请求报文和响应报文的实体部分使用的首部。补充了资源内容更 新时间等与实体有关的信息。

##### 通用首部字段

###### cache-control

s-maxage 指令的功能和 max-age 指令的相同，它们的不同点是 

s-maxage 指令只适用于供多位用户使用的公共缓存服务器 2。也就是 说，对于向同一用户重复返回响应的服务器来说，这个指令没有任何 作用。

当使用 s - maxage指令后，则直接忽略对 Expires 首部字段及 max-age 指令的处理

![](C:\Users\Administrator\Desktop\图解http笔记\http\捕获27.PNG)

###### Connection

控制不再转发给代理的首部字段
管理持久连接
控制不再转发给代理的首部字段

```
Connection: 不再转发的首部字段名
```

HTTP/1.1 版本的默认连接都是持久连接。为此，客户端会在持 久连接上连续发送请求。当服务器端想明确断开连接时，则指定 Connection 首部字段的值为 Close。

```
Connection: close
```

```
Connection: Keep-Alive
```

HTTP/1.1 之前的 HTTP 版本的默认连接都是非持久连接。为 此，如果想在旧版本的 HTTP 协议上维持持续连接，则需要指定 Connection 首部字段的值为 Keep-Alive。

##### 请求首部字段

请求首部字段是从客户端往服务器端发送请求报文中所使用的字段， 用于补充请求的附加信息、客户端信息、对响应内容相关的优先级等 内容。

###### Accept

Accept: text/html,application/xhtml+xml,application/xml;q=0.

Accept 首部字段可通知服务器，用户代理能够处理的媒体类型及媒体 类型的相对优先级。

###### Accept-Charset

Accept-Charset 首部字段可用来通知服务器用户代理支持的字符集及 字符集的相对优先顺序。

###### Accept-Encoding

Accept-Encoding 首部字段用来告知服务器用户代理支持的内容编码及 内容编码的优先级顺序

```
Accept-Encoding: gzip, deflate
```

###### Accept-Language

```
Accept-Language: zh-cn,zh;q=0.7,en-us,en;q=0.3
```

首部字段 Accept-Language 用来告知服务器用户代理能够处理的自然 语言集（指中文或英文等），以及自然语言集的相对优先级。可一次 指定多种自然语言集。

###### Authorization

首部字段 Authorization 是用来告知服务器，用户代理的认证信息（证 书值）。通常，想要通过服务器认证的用户代理会在接收到返回的 401 状态码响应后，把首部字段 Authorization 加入请求中。共用缓存 在接收到含有 Authorization 首部字段的请求时的操作处理会略有差 异。

```
Authorization: Basic dWVub3NlbjpwYXNzd29yZA==
```

###### Host

请求被发送至服务器时，请求中的主机名会用 IP 地址直接替换解 决。但如果这时，相同的 IP 地址下部署运行着多个域名，那么服务 器就会无法理解究竟是哪个域名对应的请求。因此，就需要使用首部 字段 Host 来明确指出请求的主机名。

```
Host: www.hackr.jp
```

###### if-XXX

形如 If-xxx 这种样式的请求首部字段，都可称为条件请求。服务器接 收到附带条件的请求后，只有判断指定条件为真时，才会执行请求。

If-Unmodified-Since 和首部字段 If-Modified-Since 的作用相 反

只有在 If-None-Match 的字段值与 ETag值不一致时，可处理 该请求。与 If-Match 首部字段的作用相反 

###### Max-Forwards

```
Max-Forwards: 10
```

每次转发数值减 1。当数值变 0 时返回响应

通过 TRACE 方法或 OPTIONS 方法，发送包含首部字段 MaxForwards 的请求时，该字段以十进制整数形式指定可经过的服务器最 大数目。服务器在往下一个服务器转发请求之前，Max-Forwards 的 值减 1 后重新赋值。当服务器接收到 Max-Forwards 值为 0 的请求 时，则不再进行转发，而是直接返回响应

使用 HTTP 协议通信时，请求可能会经过代理等多台服务器。途中， 如果代理服务器由于某些原因导致请求转发失败，客户端也就等不到 服务器返回的响应了。对此，我们无从可知。
可以灵活使用首部字段 Max-Forwards，针对以上问题产生的原因展 开调查。由于当 Max-Forwards 字段值为 0 时，服务器就会立即返回 响应，由此我们至少可以对以那台服务器为终点的传输路径的通信状 况有所把握。

###### Range

对于只需获取部分资源的范围请求，包含首部字段 Range 即可告知服 务器资源的指定范围

接收到附带 Range 首部字段请求的服务器，会在处理请求之后返回状 态码为 206 Partial Content 的响应。无法处理该范围请求时，则会返 回状态码 200 OK 的响应及全部资源。

###### User-Agent

```
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:13.0) Gecko
```

首部字段 User-Agent 会将创建请求的浏览器和用户代理名称等信息传 达给服务器。

##### 响应首部字段

###### Accept-Rangers

首部字段 Accept-Ranges 是用来告知客户端服务器是否能处理范围请 求，以指定获取服务器端某个部分的资源。

###### Age

若创建该响应的服务器是缓存服务器，Age 值是指缓存后的响应再次 发起认证到认证完成的时间值。代理创建响应时必须加上首部字段 Age。 

###### `Etags`

首部字段` ETag` 能告知客户端实体标识。它是一种可将资源以字符串 形式做唯一性标识的方式。服务器会为每份资源分配对应的 `ETag` 值。

强` ETag `值 

强 `ETag`值，不论实体发生多么细微的变化都会改变其值。

弱 `ETag` 值 弱 `ETag` 值只用于提示资源是否相同。只有资源发生了根本改变，产 生差异时才会改变 ETag 值。这时，会在字段值最开始处附加 W/。

###### Location

使用首部字段 Location 可以将响应接收方引导至某个与请求 URI 位置 不同的资源。

```
Location: http://www.usagidesign.jp/sample.html
```

该字段会配合 3xx ：Redirection 的响应，提供重定向的 URI。 几乎所有的浏览器在接收到包含首部字段 Location 的响应后，都会强 制性地尝试对已提示的重定向资源的访问。

###### Retry-After

首部字段 Retry-After 告知客户端应该在多久之后再次发送请求。主要 配合状态码 503 Service Unavailable 响应，或 3xx Redirect 响应一起使用。

###### Server

首部字段 Server 告知客户端当前服务器上安装的 HTTP 服务器应用程 序的信息。不单单会标出服务器上的软件应用名称，还有可能包括版 本号和安装时启用的可选项。

```
Server: Apache/2.2.6 (Unix) PHP/5.2.5
```

###### Vary

当代理服务器接收到带有 Vary 首部字段指定获取资源的请求 时，如果使用的 Accept-Language 字段的值相同，那么就直接从缓 存返回响应。反之，则需要先从源服务器端获取资源后才能作为响应返回

```
Vary: Accept-Language
```

首部字段 Vary 可对缓存进行控制。源服务器会向代理服务器传达关 于本地缓存使用方法的命令。
从代理服务器接收到源服务器返回包含 Vary 指定项的响应之后，若 再要进行缓存，仅对请求中含有相同 Vary 指定首部字段的请求返回 缓存。即使对相同资源发起请求，但由于 Vary 指定的首部字段不相 同，因此必须要从源服务器重新获取资源。

![](C:\Users\Administrator\Desktop\图解http笔记\http\捕获28.PNG)

首部字段 Vary 可对缓存进行控制。源服务器会向代理服务器传达关 于本地缓存使用方法的命令。
从代理服务器接收到源服务器返回包含 Vary 指定项的响应之后，若 再要进行缓存，仅对请求中含有相同 Vary 指定首部字段的请求返回 缓存。即使对相同资源发起请求，但由于 Vary 指定的首部字段不相 同，因此必须要从源服务器重新获取资源。

###### WWW-Authenticate

首部字段 WWW-Authenticate 用于 HTTP 访问认证。它会告知客户端 适用于访问请求 URI 所指定资源的认证方案（Basic 或是 Digest）和 带参数提示的质询（challenge）。状态码 401 Unauthorized 响应中， 肯定带有首部字段 WWW-Authenticate

##### 实体首部字段

###### Allow

```
Allow: GET, HEAD
```

首部字段 Allow 用于通知客户端能够支持 Request-URI 指定资源的所 有 HTTP 方法。当服务器接收到不支持的 HTTP 方法时，会以状态码 405 Method Not Allowed 作为响应返回。与此同时，还会把所有能支 持的 HTTP 方法写入首部字段 Allow 后返回。 

###### Content-Encoding

```
Content-Encoding: gzip
```

首部字段 Content-Encoding 会告知客户端服务器对实体的主体部分选 用的内容编码方式。内容编码是指在不丢失实体信息的前提下所进行 的压缩。

压缩形式

gzip

compress

deflate

identity

###### Content-Language 

首部字段 Content-Language 会告知客户端，实体主体使用的自然语言 （指中文或英文等语言）。

###### 　Content-Length

首部字段 Content-Length 表明了实体主体部分的大小（单位是字 节）。对实体主体进行内容编码传输时，不能再使用 Content-Length 首部字段

###### Content-Type

首部字段 Content-Type 说明了实体主体内对象的媒体类型。和首部字 段 Accept 一样，字段值用 type/subtype 形式赋值。

###### Content-Range

针对范围请求，返回响应时使用的首部字段 Content-Range，能告知客 户端作为响应返回的实体的哪个部分符合范围请求。字段值以字节为 单位，表示当前发送部分及整个实体大小。

###### Content-Location

首部字段 Content-Location 给出与报文主体部分相对应的 URI。和首 部字段 Location 不同，Content-Location 表示的是报文主体返回资源对 应的 URI。 

###### Expires

缓存过期的时间

###### Last-Modified

首部字段 Last-Modified 指明资源最终修改的时间。一般来说，这个 值就是 Request-URI 指定资源被修改的时间

##### Cookie

| 首部字段名 | 说明                           | 首部类型     |
| ---------- | ------------------------------ | ------------ |
| Set-Cookie | 开始状态管理所使用的Cookie信息 | 响应首部字段 |
| Cookie     | 服务器接收到的Cookie信息       | 请求首部字段 |

![](C:\Users\Administrator\Desktop\图解http笔记\http\捕获29.PNG)

### HTTPS 的使用

#### Http的缺点

##### 通信使用明文（不加密），内容可能会被窃听
##### 不验证通信方的身份，因此有可能遭遇伪装

##### 无法证明报文的完整性，所以有可能已遭篡改

![](C:\Users\Administrator\Desktop\图解http笔记\http\捕获30.PNG)

#### HTTPS 　HTTP+ 加密 + 认证 + 完整性保护 =HTTPS 

##### HTTP 加上加密处理和认证以及完整性保护后即是 HTTPS 

对于 HTTP 来说，服务器也好，客户端也好，都是没有办法确认通信方的。因为很有可能并不是和原本预想的通信方在实际通信。 并且还需要考虑到接收到的报文在通信途中已经遭到篡改这一可能 性。

为了统一解决上述这些问题，需要在 HTTP 上再加入加密处理和认证 等机制。我们把添加了加密及认证机制的 HTTP 称为 HTTPS

![](C:\Users\Administrator\Desktop\图解http笔记\http\捕获31.PNG)

##### HTTPS 是身披 SSL 外壳的 HTTP

HTTPS 并非是应用层的一种新协议。只是 HTTP 通信接口部分用 SSL（Secure Socket Layer）和 TLS（Transport Layer Security）协议代 替而已。

HTTP 直接和 TCP 通信。当使用 SSL 时，则演变成先和 SSL 通 信，再由 SSL 和 TCP 通信了。简言之，所谓 HTTPS，其实就是身披 SSL 协议这层外壳的 HTTP。在采用 SSL 后，HTTP 就拥有了 HTTPS 的加密、证书和完整性保护 这些功能.

![](C:\Users\Administrator\Desktop\图解http笔记\http\捕获32.PNG)

##### 共享密钥加密

加密和解密同用一个密钥的方式称为共享密钥加密（Common key crypto system），也被叫做对称密钥加密

#####  相互交换密钥的公开密钥加密技术

SSL 采用一种 叫做公开密钥加密（Public-key cryptography）的加密处理方式

使用两把密钥的公开密钥加密

公开密钥加密使用一对非对称的密钥。一把叫做私有密钥 （private key），另一把叫做公开密钥（public key）。顾名思 义，私有密钥不能让其他任何人知道，而公开密钥则可以随意发 布，任何人都可以获得。

使用公开密钥加密方式，发送密文的一方使用对方的公开密钥进 行加密处理，对方收到被加密的信息后，再使用自己的私有密钥 进行解密。利用这种方式，不需要发送用来解密的私有密钥，也 不必担心密钥被攻击者窃听而盗走。

![](C:\Users\Administrator\Desktop\图解http笔记\http\捕获33.PNG)

##### HTTPS 采用混合加密机制

HTTPS 采用共享密钥加密和公开密钥加密两者并用的混合加密 机制。若密钥能够实现安全交换，那么有可能会考虑仅使用公开 密钥加密来通信。但是公开密钥加密与共享密钥加密相比，其处 理速度要慢。
所以应充分利用两者各自的优势，将多种方法组合起来用于通 信。在交换密钥环节使用公开密钥加密方式，之后的建立通信交 换报文阶段则使用共享密钥加密方式。

![](C:\Users\Administrator\Desktop\图解http笔记\http\捕获34.PNG)



先交换公钥,然后客户端生成一个预主密钥,然后拿服务端的公钥对这个预主密钥进行加密,然后发给服务端,服务端拿私钥进行解密得到预主密钥,然后客户端和服务端都拿这个预主密钥,服务端公钥,客户端公钥生成共享密钥,再拿这个密钥进行加密和解密

##### 公开密钥正确性的证书

公开密钥加密方式还是存在一些问题的。那就是无法证明 公开密钥本身就是货真价实的公开密钥。

正准备和某台服务器 建立公开密钥加密方式下的通信时，如何证明收到的公开密钥就是原本预想的那台服务器发行的公开密钥。或许在公开密钥传输途中，真正的公开密钥已经被攻击者替换掉了。(无法认证给你密钥的服务器就是你想要访问的服务器,因为可以存在着DNS欺骗的问题)

可以使用由数字证书认证机构（CA，Certificate Authority）和其相关机关颁发的公开密钥证书。

数字证书认证机构处于客户端与服务器双方都可信赖的第三方机构的 立场上

首先，服务器 的运营人员向数字证书认证机构提出公开密钥的申请。数字证书认证 机构在判明提出申请者的身份之后，会对已申请的公开密钥做数字签 名，然后分配这个已签名的公开密钥，并将该公开密钥放入公钥证书 后绑定在一起。

数字签名是使用CA机构的私钥加密生成的,数字签名的解密是用CA机构的公钥,这个一般内置在浏览器中,或者通过网络去获取CA机构的公钥,对签名进行解密后得到的东西就是证书上的东西,包括服务器的公钥和服务器网站的信息,CA机构也就是拿这些信息去进行加密生成签名的

服务器会将这份由数字证书认证机构颁发的公钥证书发送给客户端，以进行公开密钥加密方式通信。公钥证书也可叫做数字证书或直接称 为证书。

接到证书的客户端可使用数字证书认证机构的公开密钥，对那张证书 上的数字签名进行验证，一旦验证通过，客户端便可明确两件事： 一，认证服务器的公开密钥的是真实有效的数字证书认证机构。二， 服务器的公开密钥是值得信赖的。

此处认证机关的公开密钥必须安全地转交给客户端。使用通信方式 时，如何安全转交是一件很困难的事，因此，多数浏览器开发商发布 版本时，会事先在内部植入常用认证机关的公开密钥。

![](C:\Users\Administrator\Desktop\图解http笔记\http\捕获35.PNG)

##### 可证明组织真实性的 EV SSL 证书

##### 用以确认客户端的客户端证书

##### 认证机构信誉第一

##### 由自认证机构颁发的证书称为自签名证书

值得信赖的第三方机构介入认证，才能让已植入在浏览器内的认 证机构颁布的公开密钥发挥作用，并借此证明服务器的真实性

![](C:\Users\Administrator\Desktop\图解http笔记\http\捕获36.PNG)

HTTPS 比 HTTP 要慢 2 到 100 倍 

TSL 是以 SSL 为原型开发的协议，有时会统一称该协议 为 SSL

SSL 的慢分两种。一种是指通信慢。另一种是指由于大量消耗 CPU 及内存等资源，导致处理速度变慢。 和使用 HTTP 相比，网络负载可能会变慢 2 到 100 倍。除去和 TCP 连接、发送 HTTP 请求 • 响应以外，还必须进行 SSL 通信， 因此整体上处理通信量不可避免会增加。

另一点是 SSL 必须进行加密处理。在服务器和客户端都需要进行 加密和解密的运算处理。因此从结果上讲，比起 HTTP 会更多地 消耗服务器和客户端的硬件资源，导致负载增强。

要进行 HTTPS 通信，证书是必不可少的。而使用的证书必须向认 证机构（CA）购买。证书价格可能会根据不同的认证机构略有不 同。通常，一年的授权需要数万日元（现在一万日元大约折合 600 人民币）。

在进行加密处理时，并非对所有内容都 进行加密处理，而是仅在那些需要信息隐藏时才会加密，以节约资源。

因为与纯文本通信相比，加密通信会消耗更多的 CPU 及内存资源。如果每次通信都加密，会消耗相当多的资源，平摊到一台计算机上时，能够处理的请求数量必定也会随之减少。因此，如果是非敏感信息则使用 HTTP 通信，只有在包含个人信息 等敏感数据时，才利用 HTTPS 加密通信。 